server {
    listen 80;
    server_name localhost;

    root /usr/share/nginx/html;
    index index.html;

    # ── Security headers ─────────────────────────────────────────────
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # ── Gzip ─────────────────────────────────────────────────────────
    gzip on;
    gzip_types text/plain text/css application/javascript application/json image/svg+xml;
    gzip_min_length 256;

    # ── Disable caching for HTML (active development) ────────────────
    location ~* \.html$ {
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
    }

    # ── Disable caching for CSS/JS (active development) ────────────
    location ~* \.(css|js)$ {
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
    }

    # ── Static asset caching (images/fonts) ────────────────────────
    location ~* \.(jpg|jpeg|png|gif|svg|webp|ico|woff2?)$ {
        expires 7d;
        add_header Cache-Control "public, immutable";
    }

    # ── SPA-friendly fallback (clean URLs) ───────────────────────────
    location / {
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
        try_files $uri $uri/ $uri.html =404;
    }

    # ── Custom error page ────────────────────────────────────────────
    error_page 404 /404.html;
    location = /404.html {
        internal;
    }

    # ── Block dotfiles ───────────────────────────────────────────────
    location ~ /\. {
        deny all;
        return 404;
    }

    # ── Block non-public directories ─────────────────────────────────
    location ~* ^/(apps-script|archive|deploy|node_modules)/ {
        deny all;
        return 404;
    }

    # ── Block dev/config files from being served ─────────────────────
    location ~* (CLAUDE\.md|README\.md|\.txt|docker-compose|Dockerfile)$ {
        deny all;
        return 404;
    }
}
